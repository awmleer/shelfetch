<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shelfetch</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="http://apps.bdimg.com/libs/jquery/2.0.0/jquery.min.js"></script>
    <!--<script src="js/jquery.min.js"></script>-->
    <!--最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!--<script src="js/bootstrap.min.js"></script>-->

    <!-- 加载waiting特效css -->
    <link rel="stylesheet" type="text/css" href="css/spinner.css">

    <script>
        function g(id) {
            return document.getElementById(id);
        }

        $(document).ready(function () {
//          调整页面布局
            if ($(window).height() < $(window).width()) {
                $(".container").css("width", "500px");
                $(".container").css("margin", "0 auto");
            }
            var windowheight = $(window).height();
            $("#div-waiting").css("margin-top", windowheight * 0.3 + "px");

//            获取搜索的书名
            var urldata = location.search;
            urldata = urldata.replace("?", "");
            urldata = urldata.replace("#", "");
            var urltemp = urldata.split("&");
            keyword = decodeURI(urltemp[0]);
            page = urltemp[1];


            $.ajax({
                url: "http://121.42.209.162:3031/api/zju/search",
                type: "get",
                data: {
                    keyword: keyword,
                    page: page
                }
            }).done(function (data) {
                    var obj = eval(data);
                    if (obj.length == "0") {
                        $("#div-waiting").hide();
                        $("#div-noresult").show();
                        return false;
                    }

                    var i;
                    var tablehtml;

                    var tablehtml1 = "<div class='panel panel-info'>" +
                            "<div class='panel-heading'>" +
                            "<h3 class='panel-title'>shumingshuming</h3>" +
                            "</div>" +
                            "<div class='panel-body'>" +
                            "<p>索书号：suoshuhaosuoshuhao<br>作者：zuozhezuozhe<br>年份：nianfennianfen<br>出版社：chubanshechubanshe</p>" +
                            "<table width='100%' class='table table-condensed'> " +
                            "<colgroup><col width='46%'><col width='27%'><col width='27%'></colgroup> " +
                            "<thead>" +
                            "<tr><th>馆藏位置</th><th>册数/借出</th><th>查看架位</th></tr>" +
                            "</thead>" +
                            "<tbody>";
                    var tablehtml2 = "<tr><td class='c'>gcwzgcwz</td><td>csjccsjc</td><td><button onclick=\"btnclick('fgfg','suoshuhaosuoshuhao')\" class='btn btn-primary'>查看</button></td></tr>";
                    var tablehtml3 = "</tbody></table></div></div>";

                    //          初始化标头信息
                    $("#keyword").text("搜索词：" + keyword);

                    var total = obj.length;
                    $("#page").text("第" + page + "页/共" + total + "页");

//                      初始化分页模块
                    if (total < 5) {
                        var iii;
                        for (iii = total + 1; iii <= 5; iii++) {
                            $("#page" + iii).hide();
                        }
                    }


                    if (page < 3) {
                        j = 1;
                    } else if (page > total - 2) {
                        j = total - 4;
                    } else {
                        j = page - 2;
                    }
                var iii;
                    for (iii = 1; iii <= 5; iii++) {
                        $("#page" + iii + " a").text(j);
                        if (j != page)$("#page" + iii + " a").attr("href", "search.html?" + keyword + "&" + j);
                        if (j == page)$("#page" + iii).addClass("active");
                        j++;
                    }

                    for (i = 2; i < obj.length; i++) {
                        tablehtml = tablehtml1.replace("shumingshuming", obj[i].chnname);
                        tablehtml = tablehtml.replace("zuozhezuozhe", obj[i].author);
                        tablehtml = tablehtml.replace("nianfennianfen", obj[i].year);
                        tablehtml = tablehtml.replace("chubanshechubanshe", obj[i].press);

//                          解析ssh
                        var temp, reg;
                        temp = obj[i].item2_ssh.match(/ */);
                        obj[i].item2_ssh = obj[i].item2_ssh.replace(temp[0], "");
                        for (ii = 1; ii <= 3; ii++) {
                            var tabletemp = tablehtml2;
                            if (obj[i].item2_ssh == null) {
                                tabletemp = tabletemp.replace("gcwzgcwz", "正在购进中");
                                tablehtml = tablehtml.replace("suoshuhaosuoshuhao", "无");
                                tabletemp = tabletemp.replace("suoshuhaosuoshuhao", "无");
                                tabletemp = tabletemp.replace("csjccsjc", "无");
                                tablehtml = tablehtml + tabletemp;
                                break;
                            }
                            temp = obj[i].item2_ssh.match(/.+?[A-Z]/);
                            reg = /[A-Z]/;
                            temp[0] = temp[0].replace(reg, "");
                            tabletemp = tabletemp.replace("gcwzgcwz", temp[0]);
                            if (temp[0] == "紫金港基础流通书库") {
                                tabletemp = tabletemp.replace("fgfg", "zjgjc");
                            } else {
                                tabletemp = tabletemp.replace("fgfg", "else");
                            }

                            obj[i].item2_ssh = obj[i].item2_ssh.replace(temp[0], "");
                            temp = obj[i].item2_ssh.match(/.+? /);
                            temp[0] = temp[0].replaceA(" ", "");
                            tablehtml = tablehtml.replace("suoshuhaosuoshuhao", temp[0]);
                            tabletemp = tabletemp.replace("suoshuhaosuoshuhao", temp[0]);

                            obj[i].item2_ssh = obj[i].item2_ssh.replace(temp[0], "");
                            temp = obj[i].item2_ssh.match(/ +\d\/ +\d/);
                            if (temp == null)break;
                            obj[i].item2_ssh = obj[i].item2_ssh.replace(temp[0], "");
                            temp[0] = temp[0].replaceA(" ", "");
                            tabletemp = tabletemp.replace("csjccsjc", temp[0]);

                            tablehtml = tablehtml + tabletemp;
                        }

                        tablehtml = tablehtml + tablehtml3;
                        $("#bottom").before(tablehtml);
                    }
                    $("#div-waiting").hide();
                    $(".container").show();
            }).fail(function () {
                alert("获取信息失败，请稍后再试");
            });
        });
    </script>

    <style>
        .bookname {
            background-color: #eeeeee;
        }

        .container {
            margin-top: 1em;
        }

        .tablebook {
            margin-bottom: 1em;
            border: solid 1px #DDDDDD;
        }

    </style>
</head>
<body>
<div id="div-waiting" style="display: block;" class="center-block">
    <div class="spinner">
        <div class="rect1"></div>
        <div class="rect2"></div>
        <div class="rect3"></div>
        <div class="rect4"></div>
        <div class="rect5"></div>
    </div>
    <p class="text-center">正在加载中，请稍等</p>
</div>

<div id="div-noresult" style="display: none;margin-top: 10em">
    <h2 class="text-center">抱歉，没有找到<br>您搜索的图书<br><br></h2>
    <button onclick="history.go(-1)" class="btn btn-primary center-block">返回首页重新搜索</button>
</div>


<div class="container" style="display: none;">
    <button onclick="location.href='index.html'" class="btn btn-default" style="float: right;">返回</button>

    <div style="margin: 1em auto;">
        <span id="page" class="label label-primary">第1页/共x页</span>
        <span id="keyword" class="label label-primary">搜索词：keyword</span>
    </div>

    <div class="alert alert-warning">注：目前查看架位的功能仅支持紫金港基础流通书库</div>
    <!-- TODO 居中-->
    <div id="bottom" style="margin-left: 5em;margin-bottom: 2em">
        <ul style="display: block;" class="pagination">
            <li id="page1"><a href="#">1</a></li>
            <li id="page2"><a href="#">2</a></li>
            <li id="page3"><a href="#">3</a></li>
            <li id="page4"><a href="#">4</a></li>
            <li id="page5"><a href="#">5</a></li>
        </ul>
    </div>

</div>

<p class="text-center" style="margin-top: 2em;color: #8c8c8c;">sparker团队&nbsp;&nbsp;
    <!--CNZZ站长统计-->
    <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1256977739'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1256977739' type='text/javascript'%3E%3C/script%3E"));
    </script>
</p>
<script>
    String.prototype.replaceA = function (s1, s2) {
        return this.replace(new RegExp(s1, "gm"), s2);
    };

    function btnclick(fg, ssh) {
        if (ssh == "无") {
            alert("抱歉，没有索书号，无法查询");
            return false;
        }
        if (fg == "else") {
            alert("抱歉，暂时不支持该分馆的数据查询");
            return false;
        }

//      索书号预格式化
        var x = ssh;
        var reg;
        reg = /[?？][A-Z]*\d*/;
        x = x.replace(reg, "");
        reg = /[;；][A-Z]*\d*/;
        x = x.replace(reg, "");
        reg = /[:：][A-Z]*\d*/;
        x = x.replace(reg, "");
        reg = /\([A-Z]*\d*\)/;
        x = x.replace(reg, "");
        reg = /[（[A-Z]*\d*）/;
        x = x.replace(reg, "");
        reg = /[<[A-Z]*\d*>/;
        x = x.replace(reg, "");
        reg = /[“[A-Z]*\d*”/;
        x = x.replace(reg, "");
        reg = /["[A-Z]*\d*"/;
        x = x.replace(reg, "");


//      索书号格式化
        var y = "";
        var temp, temp2, deng, zimu;

//      前后切割
        x = x.split("/");

//      等号
        temp = x[0].match(/=[A-Z]*\d*/);
        if (temp == null) {
            deng = "000";
        } else {
            x[0] = x[0].replace(temp[0], "");
            temp[0] = temp[0].substr(1);
            temp2 = temp[0] + "000";
            deng = temp2.substr(0, 3);
        }


//      两位字母（首位）
        temp = x[0].match(/[A-Z]+/);
        if (temp == null) {
            y = y + "@@";
        } else {
            temp2 = temp[temp.length - 1] + "@";
            temp2 = temp2.substr(0, 2);
            y = y + temp2;
            x[0] = x[0].substr(temp[0].length);
        }


//      两位字母(末尾)
        temp = x[0].match(/[A-Z]+/);
        if (temp == null) {
            zimu = "@@";
        } else {
            temp2 = temp[temp.length - 1] + "@";
            temp2 = temp2.substr(0, 2);
            zimu = temp2;
            x[0] = x[0].replace(temp[temp.length - 1], "");
        }

        var dot = x[0].split(".");
        var len = dot.length;
        var i;
        for (i = 0; i < len; i++) {
            temp = dot[i].match(/\d+/);
            if (temp == null) {
                temp2 = "000";
            } else {
                temp2 = temp[0] + "000";
            }
            temp2 = temp2.substr(0, 3);
            y = y + temp2;
            if (temp != null)dot[i] = dot[i].substr(temp[0].length);
            if (dot[i].charAt(0) == "-") {
                dot[i] = dot[i].substr(1);
                temp = dot[i].match(/\d+/);
                temp2 = temp[0] + "000";
                temp2 = temp2.substr(0, 3);
                y = y + temp2;
                if (temp != null)dot[i] = dot[i].substr(temp[0].length);
            } else {
                y = y + "000";
            }
        }
        if (len == 1)y = y + "000000000000";
        if (len == 2)y = y + "000000";


//      补上等号和最后两个字母
        y = y + deng;
        y = y + zimu;


//      下面是后半部分
//      两位字母
        temp = x[1].match(/[A-Z]+/);
        if (temp == null) {
            y = y + "@@";
        } else {
            temp2 = temp[0] + "@";
            temp2 = temp2.substr(0, 2);
            y = y + temp2;
            if (temp != null)x[1] = x[1].substr(temp[0].length);
        }

//      三位数字
        temp = x[1].match(/\d+/);
        if (temp == null) {
            y = y + "000";
        } else {
            temp2 = temp[0] + "000";
            temp2 = temp2.substr(0, 3);
            y = y + temp2;
            if (temp != null)x[1] = x[1].substr(temp[0].length);
        }


//      剩余的数字
        if (x[1].charAt(0) == ".") {
            x[1] = x[1].substr(1);
            temp = x[1].match(/\d+/);
            if (temp == null) {
                temp2 = "000";
            } else {
                temp2 = temp[0] + "000";
            }
            temp2 = temp2.substr(0, 3);
            y = y + temp2;
            if (temp != null)x[1] = x[1].substr(temp[0].length);
            if (x[1].charAt(0) == "-") {
                x[1] = x[1].substr(1);
                temp = x[1].match(/\d+/);
                if (temp == null) {
                    temp2 = "000";
                } else {
                    temp2 = temp[0] + "000";
                }
                temp2 = temp2.substr(0, 3);
                y = y + temp2;
                if (temp != null)x[1] = x[1].substr(temp[0].length);
            }
        } else if (x[1].charAt(0) == "-") {
            y = y + "000";
            x[1] = x[1].substr(1);
            temp = x[1].match(/\d+/);
            if (temp == null) {
                temp2 = "000";
            } else {
                temp2 = temp[0] + "000";
            }
            temp2 = temp2.substr(0, 3);
            y = y + temp2;
            if (temp != null)x[1] = x[1].substr(temp[0].length);
        } else {
            y = y + "000000";
        }


        $.get("http://121.42.209.162/cgi-bin/shelfetch.py", {xx: "zju", fg: fg, ssh: y},
                function (data) {
                    var strs = data.split("&");
                    var fjh = strs[0];
                    var jh = strs[1];
                    $("#div-main").show();
                    $("#div-waiting").hide();
                    location.href = "result-" + "zju" + "-" + fg + "-" + fjh + ".html?ssh==" + ssh + "&jh=" + jh;
                }
        );
    }
</script>

</body>
</html>